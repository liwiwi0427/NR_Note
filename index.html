<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è­·ç†è¨˜éŒ„å¿«æ‰‹</title>
    <!-- 1. å¼•å…¥æ¨£å¼è¡¨ -->
    <link rel="stylesheet" href="style.css">
    <!-- 2. å¼•å…¥è³‡æ–™åº« -->
    <script src="database.js"></script>
</head>
<body>

<div class="container">
    <h1>ğŸ¥ è­·ç†è¨˜éŒ„ç”¢ç”Ÿå™¨</h1>

    <!-- ç¬¬ä¸€å€ï¼šé¸æ“‡è™•ç½®é …ç›® -->
    <div class="form-group">
        <div class="section-title">Step 1: é¸æ“‡é …ç›®</div>
        <div class="row">
            <select id="mainSelect" onchange="updateCategory()">
                <option value="">(1) ä¸»è™•ç½®...</option>
            </select>
            <select id="catSelect" onchange="updateSubCategory()" disabled>
                <option value="">(2) åˆ†é¡...</option>
            </select>
        </div>
        <div style="margin-top: 15px;">
            <select id="subSelect" onchange="renderVariables()" disabled>
                <option value="">(3) è©³ç´°å…§å®¹...</option>
            </select>
        </div>
    </div>

    <!-- ç¬¬äºŒå€ï¼šå‹•æ…‹è¼¸å…¥è®Šæ•¸ (é è¨­éš±è—) -->
    <div id="variableArea" style="display:none;">
        <div class="section-title">Step 2: å¡«å¯«è©³ç´°æ•¸æ“š</div>
        <div id="dynamicInputs"></div>
    </div>

    <!-- ç¬¬ä¸‰å€ï¼šçµæœé è¦½ -->
    <div class="form-group">
        <div class="section-title">Step 3: é è¦½èˆ‡ä¿®æ”¹</div>
        <textarea id="resultArea" placeholder="ç³»çµ±å°‡è‡ªå‹•ç”Ÿæˆè¨˜éŒ„..."></textarea>
    </div>

    <button class="btn-primary" onclick="copyText()">ğŸ“‹ è¤‡è£½åˆ°å‰ªè²¼ç°¿</button>
</div>

<!-- åå¸é€šçŸ¥ (è¤‡è£½æˆåŠŸæç¤º) -->
<div id="toast" class="toast">âœ… å·²è¤‡è£½æˆåŠŸï¼</div>

<script>
    // è®€å– database.js ä¸­çš„è³‡æ–™
    const data = window.nursingData || {};

    const mainSelect = document.getElementById('mainSelect');
    const catSelect = document.getElementById('catSelect');
    const subSelect = document.getElementById('subSelect');
    const variableArea = document.getElementById('variableArea');
    const dynamicInputs = document.getElementById('dynamicInputs');
    const resultArea = document.getElementById('resultArea');
    
    let currentTemplate = "";

    // 1. åˆå§‹åŒ–é é¢ï¼Œè¼‰å…¥ç¬¬ä¸€å±¤é¸å–®
    Object.keys(data).forEach(key => {
        mainSelect.add(new Option(key, key));
    });

    // 2. ç¬¬ä¸€å±¤æ”¹è®Š -> æ›´æ–°ç¬¬äºŒå±¤
    function updateCategory() {
        catSelect.innerHTML = '<option value="">(2) åˆ†é¡...</option>';
        subSelect.innerHTML = '<option value="">(3) è©³ç´°å…§å®¹...</option>';
        catSelect.disabled = true;
        subSelect.disabled = true;
        variableArea.style.display = 'none';
        resultArea.value = '';
        
        if (mainSelect.value && data[mainSelect.value]) {
            catSelect.disabled = false;
            Object.keys(data[mainSelect.value]).forEach(key => {
                catSelect.add(new Option(key, key));
            });
        }
    }

    // 3. ç¬¬äºŒå±¤æ”¹è®Š -> æ›´æ–°ç¬¬ä¸‰å±¤
    function updateSubCategory() {
        subSelect.innerHTML = '<option value="">(3) è©³ç´°å…§å®¹...</option>';
        subSelect.disabled = true;
        variableArea.style.display = 'none';
        resultArea.value = '';

        if (mainSelect.value && catSelect.value) {
            subSelect.disabled = false;
            const items = data[mainSelect.value][catSelect.value];
            Object.keys(items).forEach(key => {
                // value å­˜æ¨¡æ¿å…§å®¹, text å­˜é¡¯ç¤ºåç¨±
                subSelect.add(new Option(key, items[key]));
            });
        }
    }

    // 4. ç¬¬ä¸‰å±¤æ”¹è®Š -> è§£æè®Šæ•¸ {{...}}
    function renderVariables() {
        dynamicInputs.innerHTML = '';
        currentTemplate = subSelect.value;
        resultArea.value = currentTemplate;

        if (!currentTemplate) {
            variableArea.style.display = 'none';
            return;
        }

        // Regex æŠ“å–æ‰€æœ‰ {{...}}
        const regex = /{{(.*?)}}/g;
        let match;
        const vars = new Set();
        
        while ((match = regex.exec(currentTemplate)) !== null) {
            vars.add(match[1]); // æŠ“å–æ‹¬è™Ÿå…§çš„å®Œæ•´å­—ä¸²ï¼Œå¦‚ "é¡è‰²|ç´…|é»ƒ"
        }

        if (vars.size > 0) {
            variableArea.style.display = 'block';
            
            vars.forEach(tagContent => {
                const div = document.createElement('div');
                div.style.marginBottom = "15px";

                // åˆ¤æ–·æ˜¯å¦åŒ…å« '|' ç¬¦è™Ÿ (ä¸‹æ‹‰é¸å–®æ¨¡å¼)
                if (tagContent.includes('|')) {
                    // === ä¸‹æ‹‰é¸å–®æ¨¡å¼ ===
                    const parts = tagContent.split('|');
                    const labelName = parts[0]; // ç¬¬ä¸€æ®µæ˜¯æ¨™é¡Œ
                    const options = parts.slice(1); // å¾Œé¢æ˜¯é¸é …

                    let label = document.createElement('label');
                    label.innerText = labelName + " :";
                    
                    let select = document.createElement('select');
                    select.dataset.originalTag = tagContent; // è¨˜ä½åŸå§‹æ¨™ç±¤ä»¥ä¾¿æ›¿æ›
                    select.onchange = generateText; // é¸é …æ”¹è®Šæ™‚å³æ™‚æ›´æ–°

                    // é è¨­æç¤ºé¸é …
                    let defaultOpt = document.createElement('option');
                    defaultOpt.text = `(è«‹é¸æ“‡ ${labelName})`;
                    defaultOpt.value = "";
                    select.appendChild(defaultOpt);

                    // åŠ å…¥é¸é …
                    options.forEach(optText => {
                        let option = document.createElement('option');
                        option.value = optText;
                        option.text = optText;
                        select.appendChild(option);
                    });

                    div.appendChild(label);
                    div.appendChild(select);

                } else {
                    // === ä¸€èˆ¬æ–‡å­—è¼¸å…¥æ¡†æ¨¡å¼ ===
                    let label = document.createElement('label');
                    label.innerText = tagContent + " :";
                    
                    let input = document.createElement('input');
                    input.type = "text";
                    input.dataset.originalTag = tagContent; // è¨˜ä½åŸå§‹æ¨™ç±¤
                    input.placeholder = "è¼¸å…¥ " + tagContent + "...";
                    input.oninput = generateText; // è¼¸å…¥æ™‚å³æ™‚æ›´æ–°

                    div.appendChild(label);
                    div.appendChild(input);
                }

                dynamicInputs.appendChild(div);
            });
            
            // è‡ªå‹•èšç„¦ç¬¬ä¸€å€‹è¼¸å…¥æ¡† (å¦‚æœæ˜¯ input)
            const firstInput = dynamicInputs.querySelector('input');
            if (firstInput) setTimeout(() => firstInput.focus(), 100);

        } else {
            variableArea.style.display = 'none';
        }
    }

    // 5. ç”¢ç”Ÿæœ€çµ‚æ–‡å­—
    function generateText() {
        let text = currentTemplate;
        
        // æŠ“å–æ‰€æœ‰çš„ input å’Œ select
        const inputs = dynamicInputs.querySelectorAll('input, select');
        
        inputs.forEach(el => {
            const originalTag = el.dataset.originalTag; // ä¾‹å¦‚: "é¡è‰²|ç´…|é»ƒ" æˆ– "Size"
            const val = el.value;

            // åªæœ‰ç•¶ä½¿ç”¨è€…æœ‰è¼¸å…¥æˆ–é¸æ“‡æ™‚æ‰æ›¿æ›
            if (val) {
                // ä½¿ç”¨ replaceAll è™•ç†é‡è¤‡å‡ºç¾çš„è®Šæ•¸
                text = text.split(`{{${originalTag}}}`).join(val);
            }
        });
        
        resultArea.value = text;
    }

    // 6. è¤‡è£½åŠŸèƒ½
    function copyText() {
        const text = resultArea.value;
        if (!text) return;
        
        navigator.clipboard.writeText(text).then(() => {
            const toast = document.getElementById('toast');
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        });
    }
</script>
</body>
</html>
