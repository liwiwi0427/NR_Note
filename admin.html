<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è­·ç†è¨˜éŒ„å¾Œå°ç®¡ç†</title>
    <!-- å¼•å…¥æ¨£å¼èˆ‡è³‡æ–™åº« -->
    <link rel="stylesheet" href="style.css">
    <script src="database.js"></script>
</head>
<body>

<div class="admin-wrapper">
    
    <!-- å·¦å´ï¼šæ·±è‰²å´é‚Šæ¬„ -->
    <div class="sidebar-panel">
        <div class="sidebar-header">
            <div class="sidebar-title">ğŸ©º è³‡æ–™åº«ç®¡ç†</div>
            <!-- æ–°å¢ä¸»è™•ç½®æŒ‰éˆ• -->
            <button class="mini-btn" title="æ–°å¢ä¸»è™•ç½®" onclick="openModal('main')" style="width:30px; height:30px; font-size:18px;">ï¼‹</button>
        </div>
        
        <!-- æ¨¹ç‹€é¸å–®å®¹å™¨ -->
        <div class="sidebar-content" id="sidebarTree">
            <!-- JS æœƒè‡ªå‹•ç”Ÿæˆå…§å®¹ -->
        </div>
        
        <div style="padding: 15px; font-size: 12px; text-align: center; color: #64748b; border-top: 1px solid #334155;">
            Nursing Note Admin v2.0
        </div>
    </div>

    <!-- å³å´ï¼šä¸»è¦æ“ä½œå€ -->
    <div class="main-content">
        
        <!-- ç‹€æ…‹ 1: ç©ºç™½èµ·å§‹ç•«é¢ -->
        <div id="emptyState" class="empty-state">
            <div class="empty-icon">ğŸ‘ˆ</div>
            <h2>è«‹å¾å·¦å´é¸æ“‡é …ç›®é€²è¡Œç·¨è¼¯</h2>
            <p>é»æ“Šåˆ†é¡æ—çš„ã€Œï¼‹ã€è™Ÿå¯æ–°å¢å…§å®¹</p>
        </div>

        <!-- ç‹€æ…‹ 2: ç·¨è¼¯å¡ç‰‡ -->
        <div id="editorCard" class="editor-card">
            <div class="editor-header">
                <div>
                    <div class="breadcrumb" id="breadcrumbPath">Main > Category</div>
                    <div class="editor-title" id="editorTitle">Title</div>
                </div>
                <button class="btn-danger" onclick="deleteItem()">ğŸ—‘ï¸ åˆªé™¤æ­¤é …</button>
            </div>

            <div class="form-group" style="margin-bottom:20px;">
                <label>å…§å®¹æ¨¡ç‰ˆ (Template)</label>
                <textarea id="editorContent" style="height: 300px; font-size: 16px; line-height: 1.6;"></textarea>
                <div class="hint">ğŸ’¡ æç¤ºï¼šä½¿ç”¨ {{è®Šæ•¸åç¨±}} ä¾†å»ºç«‹å¡«ç©ºæ¬„ä½ã€‚ä¾‹å¦‚ï¼š{{Size}}ã€{{é¡è‰²}}</div>
            </div>

            <button class="btn-primary" onclick="saveCurrentItem()">ğŸ’¾ æš«å­˜ä¿®æ”¹</button>
        </div>

    </div>

    <!-- æµ®å‹•ä¸‹è¼‰æŒ‰éˆ• (FAB) -->
    <button class="fab-save" onclick="downloadDB()">
        ğŸ“¥ ä¸‹è¼‰ä¸¦è¦†è“‹æª”æ¡ˆ
    </button>

</div>

<!-- æ–°å¢åŠŸèƒ½çš„å½ˆçª— (Modal) -->
<div id="modalOverlay" class="modal-overlay">
    <div class="modal-box">
        <h3 id="modalTitle" style="color:var(--text-main); margin-top:0;">æ–°å¢é …ç›®</h3>
        
        <div class="form-group" style="margin-bottom:15px;">
            <label>åç¨± (Key Name)</label>
            <input type="text" id="newKeyInput" placeholder="è«‹è¼¸å…¥åç¨±...">
        </div>

        <!-- åªæœ‰ç¬¬ä¸‰å±¤æ‰é¡¯ç¤ºå…§å®¹è¼¸å…¥æ¡† -->
        <div class="form-group" id="newContentGroup" style="display:none; margin-bottom:15px;">
            <label>é è¨­å…§å®¹</label>
            <textarea id="newContentInput" style="height:100px;" placeholder="è¼¸å…¥è­·ç†è¨˜éŒ„å…§å®¹..."></textarea>
        </div>

        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
            <button class="btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
            <button class="btn-primary" onclick="confirmAdd()">ç¢ºå®šæ–°å¢</button>
        </div>
    </div>
</div>

<!-- åå¸é€šçŸ¥ -->
<div id="toast" class="toast">æ“ä½œæˆåŠŸ</div>

<script>
    // è¼‰å…¥è³‡æ–™åº«ï¼Œè‹¥ç„¡å‰‡åˆå§‹åŒ–ç‚ºç©ºç‰©ä»¶
    let db = window.nursingData || {};
    
    // ç•¶å‰é¸å–çš„è·¯å¾‘ [ä¸»è™•ç½®, åˆ†é¡, é …ç›®]
    let currentPath = []; 
    
    // æ–°å¢ç‹€æ…‹æš«å­˜
    let addState = {
        level: '', // 'main', 'cat', 'item'
        parentPath: []
    };

    // DOM å…ƒç´ åƒè€ƒ
    const treeContainer = document.getElementById('sidebarTree');
    const emptyState = document.getElementById('emptyState');
    const editorCard = document.getElementById('editorCard');
    const modalOverlay = document.getElementById('modalOverlay');

    // ==========================================
    // 1. æ¸²æŸ“æ¨¹ç‹€é¸å–® (Core Logic)
    // ==========================================
    function renderTree() {
        treeContainer.innerHTML = '';
        
        // ç¬¬ä¸€å±¤ï¼šä¸»è™•ç½® (Main)
        Object.keys(db).forEach(mainKey => {
            let mainDiv = createNodeElement(mainKey, 'level-1');
            
            // åŠ å…¥ "æ–°å¢åˆ†é¡" æŒ‰éˆ•
            addActionBtn(mainDiv, 'ï¼‹', 'æ–°å¢åˆ†é¡', (e) => {
                e.stopPropagation();
                openModal('cat', [mainKey]);
            });
            
            treeContainer.appendChild(mainDiv);

            // ç¬¬äºŒå±¤ï¼šåˆ†é¡ (Category)
            const cats = db[mainKey];
            Object.keys(cats).forEach(catKey => {
                let catDiv = createNodeElement(catKey, 'level-2');
                
                // åŠ å…¥ "æ–°å¢å…§å®¹" æŒ‰éˆ•
                addActionBtn(catDiv, 'ï¼‹', 'æ–°å¢å…§å®¹', (e) => {
                    e.stopPropagation();
                    openModal('item', [mainKey, catKey]);
                });

                treeContainer.appendChild(catDiv);

                // ç¬¬ä¸‰å±¤ï¼šé …ç›® (Item)
                const items = cats[catKey];
                Object.keys(items).forEach(itemKey => {
                    let itemDiv = createNodeElement(itemKey, 'level-3');
                    
                    // é»æ“Šäº‹ä»¶ï¼šé¸å–ç·¨è¼¯
                    itemDiv.onclick = () => selectItem(mainKey, catKey, itemKey);
                    
                    // é«˜äº®é¡¯ç¤ºç›®å‰é¸å–çš„é …ç›®
                    if(currentPath.length === 3 && 
                       currentPath[0] === mainKey && 
                       currentPath[1] === catKey && 
                       currentPath[2] === itemKey) {
                        itemDiv.classList.add('active');
                    }

                    treeContainer.appendChild(itemDiv);
                });
            });
        });
    }

    // å»ºç«‹ç¯€é» HTML çš„è¼”åŠ©å‡½å¼
    function createNodeElement(text, levelClass) {
        let div = document.createElement('div');
        div.className = `tree-node ${levelClass}`;
        div.innerHTML = `<span>${text}</span><div class="node-actions"></div>`;
        return div;
    }

    // åŠ å…¥æ“ä½œæŒ‰éˆ•çš„è¼”åŠ©å‡½å¼
    function addActionBtn(node, text, title, onClick) {
        let btn = document.createElement('button');
        btn.className = 'mini-btn';
        btn.innerHTML = text;
        btn.title = title;
        btn.onclick = onClick;
        node.querySelector('.node-actions').appendChild(btn);
    }

    // ==========================================
    // 2. ç·¨è¼¯èˆ‡é¸å–åŠŸèƒ½
    // ==========================================
    function selectItem(main, cat, item) {
        currentPath = [main, cat, item];
        
        // æ›´æ–° UI ç‹€æ…‹
        renderTree(); 
        emptyState.style.display = 'none';
        editorCard.style.display = 'block';

        // å¡«å…¥è³‡æ–™
        document.getElementById('breadcrumbPath').innerText = `${main} > ${cat}`;
        document.getElementById('editorTitle').innerText = item;
        document.getElementById('editorContent').value = db[main][cat][item];
    }

    function saveCurrentItem() {
        if(currentPath.length !== 3) return;
        const [main, cat, item] = currentPath;
        
        // æ›´æ–°è¨˜æ†¶é«”ä¸­çš„è³‡æ–™
        db[main][cat][item] = document.getElementById('editorContent').value;
        showToast("âœ… å·²æš«å­˜ä¿®æ”¹");
    }

    function deleteItem() {
        if(currentPath.length !== 3) return;
        const [main, cat, item] = currentPath;
        
        if(confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${item}ã€å—ï¼Ÿ\n(æ³¨æ„ï¼šæ­¤å‹•ä½œéœ€ä¸‹è¼‰å­˜æª”å¾Œæ‰ç®—çœŸæ­£å®Œæˆ)`)) {
            delete db[main][cat][item];
            
            // é‡ç½®ç‹€æ…‹
            currentPath = [];
            editorCard.style.display = 'none';
            emptyState.style.display = 'block';
            renderTree();
            showToast("ğŸ—‘ï¸ å·²åˆªé™¤");
        }
    }

    // ==========================================
    // 3. æ–°å¢åŠŸèƒ½ (Modal)
    // ==========================================
    function openModal(level, parentPath = []) {
        addState.level = level;
        addState.parentPath = parentPath;
        
        // æ¸…ç©ºä¸¦è¨­å®š Modal å…§å®¹
        document.getElementById('newKeyInput').value = '';
        document.getElementById('newContentInput').value = '';
        
        let title = '';
        if (level === 'main') title = 'æ–°å¢ä¸»è™•ç½®';
        else if (level === 'cat') title = `åœ¨ [${parentPath[0]}] ä¸‹æ–°å¢åˆ†é¡`;
        else title = `åœ¨ [${parentPath[1]}] ä¸‹æ–°å¢å…§å®¹`;
        
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('newContentGroup').style.display = (level === 'item') ? 'block' : 'none';
        
        modalOverlay.classList.add('show');
        setTimeout(()=> document.getElementById('newKeyInput').focus(), 100);
    }

    function closeModal() {
        modalOverlay.classList.remove('show');
    }

    function confirmAdd() {
        const key = document.getElementById('newKeyInput').value.trim();
        if(!key) { alert("è«‹è¼¸å…¥åç¨±ï¼"); return; }

        // æ ¹æ“šå±¤ç´šæ–°å¢è³‡æ–™çµæ§‹
        if(addState.level === 'main') {
            if(!db[key]) db[key] = {};
        } 
        else if(addState.level === 'cat') {
            const [pMain] = addState.parentPath;
            if(!db[pMain][key]) db[pMain][key] = {};
        } 
        else if(addState.level === 'item') {
            const [pMain, pCat] = addState.parentPath;
            const content = document.getElementById('newContentInput').value;
            db[pMain][pCat][key] = content;
        }

        closeModal();
        renderTree();
        showToast("âœ¨ æ–°å¢æˆåŠŸ");
    }

    // ==========================================
    // 4. åŒ¯å‡ºä¸‹è¼‰åŠŸèƒ½
    // ==========================================
    function downloadDB() {
        // å°‡ JSON è½‰å› JavaScript æª”æ¡ˆå­—ä¸²
        const content = `window.nursingData = ${JSON.stringify(db, null, 4)};`;
        
        const blob = new Blob([content], { type: "text/javascript" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "database.js";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast("â¬‡ï¸ æª”æ¡ˆå·²ä¸‹è¼‰ï¼Œè«‹è¦†è“‹åŸæª”");
    }

    // é¡¯ç¤ºæç¤ºè¨Šæ¯
    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2000);
    }

    // åˆå§‹åŒ–
    window.onload = renderTree;
</script>

</body>
</html>
